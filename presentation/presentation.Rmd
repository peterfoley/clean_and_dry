---
title: "Staying clean and DRY"
subtitle: "best practices for code reuse and collaboration"
author: "Peter Foley"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  xaringan::moon_reader:
    seal: true
    css: ["ninjutsu", "default", "default-fonts", "presentation.css"]
    nature:
      highlightStyle: github
      highlightLines: true
    includes:
      in_header: presentation_head.html
      after_body: presentation_body.html
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
here <- here::here
library(dplyr)
library(purrr)
library(tibble)
library(fs)
```

TODO - About me

---
Why bother keeping things organized

Walk through example project with evolving needs
  - will go through R's options for organizing code cleanly
  - will give tips for each option
  - will demonstrate when to switch between options

---
## Glossary

- Side Effects
- Clean Code
- Don't repeat yourself

---
layout: true
## Glossary - Side Effect

> change something other than arguments or return values

```{r eval=FALSE}
coffee_pot <- make_a_pot(cups = 12)
```

---
.pull-left[
No side effects:
```{r eval=FALSE, size="small"}
temp <-
  temperature(coffee_pot)

stream <-
  pour_from(coffee_pot,
            cups=2)
filled_cup <-
  pour_into(empty_cup,
            stream)
```
]

.pull-right[
TODO - picture of pouring coffee
]

---
.pull-left[
Side effect!:
```{r eval=FALSE}
*dump_on_floor(coffee_pot)
```
]

.pull-right[
TODO - picture of coffee spill
]


---
layout:false
## Glossary - Don't Repeat Yourself

TODO


---
## Glossary - Clean Code

TODO

---
## Why bother?

- If any of these apply to you:
  - You can't remember everything perfectly forever
  - Other people don't know what you know
  - You sometimes make mistakes and want to fix them

--

Reading code is harder than writing it

---
# Options for organizing code

- standalone scripts
- utility scripts (`source("utils.R")`)
- utility package (`devtools::load_all("utils_pkg")`)
- standalone package (`library(package)`)

--

An actual project will make things clearer

---
# The Initial Project

Plot all my dog walks, colored by elevation.

.project-equation[
  .project-equation-item[
    ![garmin_logo][garmin_logo]]
  .project-equation-char[x]
  .project-equation-item[
    ![dogpicture][dog_face]]
  .project-equation-char[=]
  .project-equation-item[
    ![dogmap][dogmap_standalone]]
]

[dog_face]: photos/dog_face.jpeg
[dogmap_standalone]: links/0_standalone_scripts/dog_walks.png
[garmin_logo]: https://user-images.githubusercontent.com/6187884/29765129-3d63e67e-8bda-11e7-81c8-7beaf915a02a.jpg

---
class: center, middle

```{r standalone_flow, results="asis", echo=FALSE, fig.align='center', fig.retina=3}
diagram <- DiagrammeR::mermaid("
  graph TD
      setup_keys[setup_keys.R]
      get_downloader[get_downloader.R]
      download_data[download_data.R]
      map_dog_walks[map_dog_walks.R]
      
      class setup_keys,get_downloader,download_data,map_dog_walks script
    
      creds>Stored Garmin Credentials]
      downloader>Python Download Tool]
      fitfiles>Downloaded FIT files]
      dog_walks>Map of walks]
      
      class creds,downloader,fitfiles,dog_walks data
      
      setup_keys --> creds
      get_downloader --> downloader
      creds --> download_data
      download_data --> fitfiles
      downloader --> download_data
      fitfiles --> map_dog_walks
      map_dog_walks --> dog_walks
      
      classDef script fill:#f96,stroke-width:0px
      classDef invisible opacity:1.0
      classDef data stroke-width:0px
")
widgetframe::frameWidget(diagram, width="100%", height="100%")
```

---

```{r include=FALSE}
standalone <- function(..., lines=50) {
  res <- readLines(here(fs::path("0_standalone_scripts",...)))
  if(length(res) > lines) {
    n_more <- length(res)-lines
    res[lines+1] <- paste0("...(",n_more," more lines)...")
    lines <- lines+1
  }
  head(res, lines)
}
```

.pull-left[
**`setup_keys.R`**
.tinycode[
```{r eval=FALSE, code=standalone("setup_keys.R")}
```
]

**`download_data.R`**
.tinycode[
```{r eval=FALSE, code=standalone("download_data.R")}
```
]
]

.pull-right[
**`get_downloader.R`**
.tinycode[
```{r eval=FALSE, code=standalone("get_downloader.R", lines=Inf)}
```
]

**`map_dog_walks.R`**
.tinycode[
```{r eval=FALSE, code=standalone("map_dog_walks.R")}
```
]
]


---
class: center, middle

```{r ref.label='standalone_flow', echo=FALSE, results="asis"}
```

---
# Utility scripts

`.R` files that are `source()`'ed to define functions or variables.

> Note: `config` can handle a lot of configuration needs

```{r eval=FALSE, tidy=FALSE}
library(dplyr)
library(ggplot2)

source("utils_data.R")
source("utils_mapping.R")

get_the_data(date="2019-11-23") %>% #<<
  filter(driver=="Penelope") %>%
  map_all_drives() #<<
```


---
layout: true
## Standalone → Utility scripts

---
Why put things in utility scripts?
  - less code
  - write once for all collaborators
  - separates "define how to do X" from "do X"
    - more readable "do stuff" scripts

---
Do put in utility scripts:
  - Shared configuration (file locations, etc.)
  - Shared needs (DB authentication, loading particular data)
  - Big ugly function definitions

---
Do NOT put in:
  - code that actually takes actions
    - reading data
    - writing data
    - saving plots
    - user interaction
  - `source()` calls to other utility scripts

---
layout: true
## New utility scripts

---
.pull-left[
**`utils/config.R`**
```r
strict_config(value, ...)
```
]
.pull-right[
**`utils/mapping.R`**
```{r eval=FALSE, tidy=T}
get_all_activities()
get_activity_data(id)
flatten_activities(nested)
latlon_bb(df, lat=df$lat,
          lon=df$lon)
pad_bb(bb, lat=1.1,
       lon=lat)
make_basemap(flat_data, zoom=16)
```
]

---
.center[
```{r echo=FALSE, results='asis'}
scriptRows <- function(adir) {
  tibble(path=dir_ls(adir, glob="*.R", recurse=1)) %>%
    transmute(file=basename(path),
           lines=map_int(path, R.utils::countLines))
}
counts <- tribble(
  ~version, ~dir,
  "Standalone", "0_standalone_scripts",
  "Utility", "1_utility_scripts"
) %>%
  mutate(dir = here(dir),
         data = map(dir, scriptRows)) %>%
  tidyr::unnest(data) %>%
  select(version, file, lines) %>%
  tidyr::pivot_wider(file, names_from=version, values_from=lines) %>%
  arrange(desc(Standalone), desc(Utility)) %>%
  set_names(c("","Pre","Post"))

oldopt <- options(knitr.kable.NA = '-')
knitr::kable(counts, format="html")
options(oldopt)
```
]


---
layout:false
```{r utility_flow, results="asis", echo=FALSE, fig.align='center', fig.retina=3}
diagram <- DiagrammeR::mermaid("
  graph TD
      setup_keys[setup_keys.R]
      get_downloader[get_downloader.R]
      download_data[download_data.R]
      map_dog_walks[map_dog_walks.R]
      map_runs[map_runs.R]
      
      class setup_keys,get_downloader,download_data script
      class map_dog_walks,map_runs script
    
      creds>Stored Garmin Credentials]
      downloader>Python Download Tool]
      fitfiles>Downloaded FIT files]
      dog_walks>Map of walks]
      runs>Map of runs]
      
      class creds,downloader,fitfiles,dog_walks,runs data
      
      setup_keys --> creds
      get_downloader --> downloader
      creds --> download_data
      download_data --> fitfiles
      downloader --> download_data
      fitfiles --> map_dog_walks
      map_dog_walks --> dog_walks
      fitfiles --> map_runs
      map_runs --> runs
      
      subgraph utils
        config_utils[config.R]
        mapping_utils[mapping.R]
      end
      
      config_utils -.-> setup_keys
      config_utils -.-> download_data
      config_utils -.-> get_downloader
      config_utils -.-> map_dog_walks
      config_utils -.-> map_runs
      mapping_utils -.-> map_dog_walks
      mapping_utils -.-> map_runs
      
      classDef script fill:#f96,stroke-width:0px
      classDef invisible opacity:1.0
      classDef data stroke-width:0px
")
widgetframe::frameWidget(diagram, width="100%", height="100%")
```

---
background-image: url("photos/kids_win.jpg")
background-position: center
background-size: contain

---
# What did we win?

All configuration in one place

Very easy to add a new mapping script.

RStudio will pop up argument names when you're typing the function.

.center[
<img src="photos/source_func_completion.png" style="width:60%">
]

---
## What's missing?

Function help/documentation

.center[
<img src="photos/source_no_help.png" style="width:100%">
]


Gets complicated when utility functions need each other
> Mapping scripts only need `utils/config.R` to let `utils/mapping.R` functions find data.

Hard to know what packages the utilities require:
> `utils/config.R` needs `config`
> `utils/mapping.R` needs `ggmap`, `fs`, ...


---
# That sounds familiar...

.pull-left[
![boy_thinking](photos/dog_lookright.jpeg)
]
--
.pull-right[
<img src="http://r-pkgs.had.co.nz/cover.png" style="width:100%">
]

---
# A Package!

Docs/help integrate nicely with RStudio

Namespace lets everything work together

Dependencies are well defined

---

<div style="text-align:center;font-size:250%"><br>BUT</div>
<div style="text-align:center;font-size:175%"><br>Packages are complicated</div>
--
<div style="text-align:center;font-size:150%"><br>and I just have a little code</div>
--
<div style="text-align:center;font-size:125%"><br>just for this one project</div>
--
<div style="text-align:center;font-size:100%"><br>and I don't want to have to install it</div>
--
<div style="text-align:center;font-size:75%"><br>and please don't make me pick a name</div>

---
# The solution

--

.boom[
<h1><code class="remark-inline-code">devtools::load_all()</code></h1>
]

---
# `?devtools::load_all()`

### Load Complete Package.

**`load_all`**
: loads a package. It roughly simulates what happens when a package is installed and loaded with `library()`.

```r
load_all(path = ".", reset = TRUE, recompile = FALSE,
  export_all = TRUE, helpers = TRUE, quiet = FALSE, ...)
```

**`export_all`**
: If `TRUE` (the default), export all objects. If `FALSE`, export only the objects that are listed as exports in the `NAMESPACE` file.

---
### `devtools::load_all()` lets you

.center[
Keep a tidy namespace.

Write documentation -- **or not**.

Write tests -- **or not**.

Define dependencies -- **or not**.
]

---
# Utility Scripts → Utility Package

1. Make a package skeleton
```{r eval=FALSE, tidy=T}
usethis::create_package(
  path = "myutils",
  rstudio=FALSE, open=FALSE
  )
)
```
2. Stick all your utility scripts in the `R/` folder.
```{r eval=FALSE, tidy=T}
system("mv utils/*.R myutils/R/")
```
3. Be done if you feel like it.
```{r eval=FALSE, tidy=T}
pkgload::load_all("myutils")
```

---
## Got roxygen2 docs?

.pull-left[
```r
#' Get activity data
#'
#' @param id Garmin Activity ID
#'
#' @return dataframe with one row per moment recorded
#' @export
get_activity_data <- function(id) {
  fit_path <- fs::path(strict_config("gcexport_data_dir"),"fit",paste0("activity_",id,".fit"))
  fit_data <- fit::read.fit(fit_path)
  fit_data$record
}
```
]
.pull-right[
```r
> devtools::document("myutils")
Updating myutils documentation
Writing NAMESPACE
Loading myutils
Writing NAMESPACE
> devtools::load_all("myutils")
Loading myutils
> ?get_activity_data
Rendering development documentation for 'get_activity_data'
```
<img src="photos/devtools_show_help.png" style="width:100%">
]


---
## Like tests?

1. Add the boilerplate
```r
setwd("myutils")
usethis::use_testthat()
setwd("..")
```
2. Write your tests
```r
...left as an exercise to the reader...
```
3. Test!
```r
devtools::test("myutils")
```

---
# Standalone package



---
## Tips

Internal packages:
  - function documentation will show up in rstudio as tooltips
  - README.md can be helpful 

Standalone packages:
  - `usethis::use_testthat()`
  - `usethis::use_travis()`
  - 

